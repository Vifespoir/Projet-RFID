{% extends "base.html" %}

{% block navbar %}

<div class="row">
  <div class="col-3">
    <!-- <a class="nav-item nav-link active" id="nav-home-tab" data-toggle="tab" href="#nav-home" role="tab" aria-controls="nav-home" aria-selected="true">Home</a>
    <a class="nav-item nav-link" id="nav-profile-tab" data-toggle="tab" href="#nav-profile" role="tab" aria-controls="nav-profile" aria-selected="false">Profile</a>
    <a class="nav-link" id="nav-contact-tab" data-toggle="tab" href="#nav-contact" role="tab" aria-controls="nav-contact" aria-selected="false">Contact</a> -->
    <div class="nav flex-column nav-pills" id="nav-tab" role="tablist">
      <a class="nav-link text-uppercase font-weight-bold {% if active == 'accueil' %}active{% endif %}" style="font-size: 180%;" href="{{ accueil }}">Accueil<span class="sr-only">(current)</span></a>
      <a class="nav-link text-uppercase font-weight-bold {% if active == 'historique' %}active{% endif %}" style="font-size: 180%;" href="{{ historique }}">Historique</a>
      <a class="nav-link text-uppercase font-weight-bold {% if active == 'visiteur' %}active{% endif %}" style="font-size: 180%;" href="{{ visiteur }}">Espace sans badge</a>
      <a class="nav-link text-uppercase font-weight-bold {% if active == 'admin' %}active{% endif %}" style="font-size: 180%;" href="{{ admin }}">Admin</a>
      {% if current_user.is_authenticated %}
      <a class="nav-link text-uppercase font-weight-bold" style="font-size: 180%;" href="{{ logout }}">Se d√©connecter</a>
      {% endif %}
    </div>
  </div>
  <div class="col-9">

  </div>
</div>
</br>
</br>
</br>
</br>
<div class="container" id="stream">
</div>
<script type="text/javascript">
var messages = [];
function is_in_array(item) {
  return !this.includes(item)
}
function concat_stream_div(messages, time) {
  var innerHTML = "";
  var toDelete = [];
  for (var i = 0; i < messages.length; i++) {
    if ((time - messages[i].time) > 60000) {
      toDelete.push(messages[i]);
    } else {
      innerHTML = innerHTML.concat(messages[i].data);
    }
  }
  messages = messages.filter(is_in_array, toDelete);
  var stream = document.getElementById('stream');
  stream.innerHTML = innerHTML;
  setTimeout(fade_out, 10000);
  return messages;
}
if (window.navigator.userAgent.indexOf("Edge") > -1 || window.navigator.userAgent.indexOf("MSIE") > -1) {
  var stream = document.getElementById('stream');
  stream.interHTML = "Cette application ne marche ni avec Internet Explorer ni avec Edge.";
} else {
  function sse(event) {
    var source = new EventSource('{{ url_for('stream') }}');
    source.onmessage = function(event) {
      var time = new Date();
      toDelete = [];
      messages.push({"data": String(event.data), "time": time})
      if (messages.length < 5) {
        messages = concat_stream_div(messages, time);
      } else {
        messages.shift();
        messages = concat_stream_div(messages, time);
      }
    };
  }
  sse();
}
function fade_out() {
  $("#stream").empty();
  location.reload();
}
</script>
{% endblock %}
